StartLog(LogFile="results/02-upload-dataset-to-s3.tstool.log")
# Upload the Colorado dwr stream reaches dataset to the Open Water Foundation's
# data.openwaterfoundation.org website.
#
# Define controlling properties:
# - InsertsFolder is the location of data.openwaterfoundation.org inserts for the landing page
SetProperty(PropertyName="InsertsFolder",PropertyType=String,PropertyValue="../../owf-website-data/inserts")
#
# Upload the files:
# - geojson file output by GeoProcessor
# - dataset metadata files needed for landing page
AwsS3(S3Command="UploadObjects",Region="us-west-2",Bucket="data.openwaterfoundation.org",UploadFiles="../data/co-stream-reaches.geojson:state/co/dwr/stream-reaches/co-stream-reaches.geojson,dataset.json:state/co/dwr/stream-reaches/dataset.json,dataset.png:state/co/dwr/stream-reaches/dataset.png,dataset-details.md:state/co/dwr/stream-reaches/dataset-details.md,../data/co-stream-reaches-division1.geojson:state/co/dwr/stream-reaches/co-stream-reaches-division1.geojson,../data/co-stream-reaches-division2.geojson:state/co/dwr/stream-reaches/co-stream-reaches-division2.geojson,../data/co-stream-reaches-division3.geojson:state/co/dwr/stream-reaches/co-stream-reaches-division3.geojson,../data/co-stream-reaches-division4.geojson:state/co/dwr/stream-reaches/co-stream-reaches-division4.geojson,../data/co-stream-reaches-division5.geojson:state/co/dwr/stream-reaches/co-stream-reaches-division5.geojson,../data/co-stream-reaches-division6.geojson:state/co/dwr/stream-reaches/co-stream-reaches-division6.geojson,../data/co-stream-reaches-division7.geojson:state/co/dwr/stream-reaches/co-stream-reaches-division7.geojson,../data/co-stream-reaches-district1.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district1.geojson,../data/co-stream-reaches-district2.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district2.geojson,../data/co-stream-reaches-district3.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district3.geojson,../data/co-stream-reaches-district4.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district4.geojson,../data/co-stream-reaches-districts3_4.geojson:state/co/dwr/stream-reaches/co-stream-reaches-districts3_4.geojson,../data/co-stream-reaches-district5.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district5.geojson,../data/co-stream-reaches-district6.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district6.geojson,../data/co-stream-reaches-district7.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district7.geojson,../data/co-stream-reaches-district8.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district8.geojson,../data/co-stream-reaches-district9.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district9.geojson,../data/co-stream-reaches-district10.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district10.geojson,../data/co-stream-reaches-district11.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district11.geojson,../data/co-stream-reaches-district12.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district12.geojson,../data/co-stream-reaches-district13.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district13.geojson,../data/co-stream-reaches-district14.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district14.geojson,../data/co-stream-reaches-district15.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district15.geojson,../data/co-stream-reaches-district16.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district16.geojson,../data/co-stream-reaches-district17.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district17.geojson,../data/co-stream-reaches-district18.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district18.geojson,../data/co-stream-reaches-district19.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district19.geojson,../data/co-stream-reaches-district20.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district20.geojson,../data/co-stream-reaches-district21.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district21.geojson,../data/co-stream-reaches-district22.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district22.geojson,../data/co-stream-reaches-district23.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district23.geojson,../data/co-stream-reaches-district24.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district24.geojson,../data/co-stream-reaches-district25.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district25.geojson,../data/co-stream-reaches-district26.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district26.geojson,../data/co-stream-reaches-district27.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district27.geojson,../data/co-stream-reaches-district28.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district28.geojson,../data/co-stream-reaches-district29.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district29.geojson,../data/co-stream-reaches-district30.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district30.geojson,../data/co-stream-reaches-district31.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district31.geojson,../data/co-stream-reaches-district32.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district32.geojson,../data/co-stream-reaches-district33.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district33.geojson,../data/co-stream-reaches-district34.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district34.geojson,../data/co-stream-reaches-district35.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district35.geojson,../data/co-stream-reaches-district36.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district36.geojson,../data/co-stream-reaches-district37.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district37.geojson,../data/co-stream-reaches-district38.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district38.geojson,../data/co-stream-reaches-district39.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district39.geojson,../data/co-stream-reaches-district40.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district40.geojson,../data/co-stream-reaches-district41.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district41.geojson,../data/co-stream-reaches-district42.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district42.geojson,../data/co-stream-reaches-district43.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district43.geojson,../data/co-stream-reaches-district44.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district44.geojson,../data/co-stream-reaches-district45.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district45.geojson,../data/co-stream-reaches-district46.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district46.geojson,../data/co-stream-reaches-district47.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district47.geojson,../data/co-stream-reaches-district48.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district48.geojson,../data/co-stream-reaches-district49.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district49.geojson,../data/co-stream-reaches-district50.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district50.geojson,../data/co-stream-reaches-district51.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district51.geojson,../data/co-stream-reaches-district52.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district52.geojson,../data/co-stream-reaches-district53.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district53.geojson,../data/co-stream-reaches-district54.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district54.geojson,../data/co-stream-reaches-district55.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district55.geojson,../data/co-stream-reaches-district56.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district56.geojson,../data/co-stream-reaches-district57.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district57.geojson,../data/co-stream-reaches-district58.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district58.geojson,../data/co-stream-reaches-district59.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district59.geojson,../data/co-stream-reaches-district60.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district60.geojson,../data/co-stream-reaches-district61.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district61.geojson,../data/co-stream-reaches-district62.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district62.geojson,../data/co-stream-reaches-district63.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district63.geojson,../data/co-stream-reaches-district64.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district64.geojson,../data/co-stream-reaches-district65.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district65.geojson,../data/co-stream-reaches-district66.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district66.geojson,../data/co-stream-reaches-district67.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district67.geojson,../data/co-stream-reaches-district68.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district68.geojson,../data/co-stream-reaches-district69.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district69.geojson,../data/co-stream-reaches-district70.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district70.geojson,../data/co-stream-reaches-district71.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district71.geojson,../data/co-stream-reaches-district72.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district72.geojson,../data/co-stream-reaches-district73.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district73.geojson,../data/co-stream-reaches-district76.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district76.geojson,../data/co-stream-reaches-district77.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district77.geojson,../data/co-stream-reaches-district78.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district78.geojson,../data/co-stream-reaches-district79.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district79.geojson,../data/co-stream-reaches-district80.geojson:state/co/dwr/stream-reaches/co-stream-reaches-district80.geojson")
#
# Invalidate so that files are available on the CDN as soon as possible.
# AwsCloudFront(CloudFrontCommand="ListDistributions",Region="aws-global",Comment="*data.openwaterfoundation.org*",OutputTableID="Distributions")
AwsCloudFront(CloudFrontCommand="InvalidateDistribution",Region="aws-global",Comment="*data.openwaterfoundation.org*",InvalidationPaths="/state/co/dwr/stream-reaches/*")
#
# Create the dataset catalog with landing page:
# - also list invalidations to see what is in process
AwsS3Catalog(Region="us-west-2",Bucket="data.openwaterfoundation.org",StartingPrefix="state/co/dwr/stream-reaches/",DistributionId="*data.openwaterfoundation.org*",DatasetIndexFile="results/dataset-index.html",DatasetIndexHeadFile="${InsertsFolder}/head-insert.html",DatasetIndexBodyFile="${InsertsFolder}/body-nav-insert.html",DatasetIndexFooterFile="${InsertsFolder}/footer-insert.html",UploadDatasetFiles=True,OutputTableID="Datasets",KeepFiles=True)
# AwsCloudFront(CloudFrontCommand="ListInvalidations",Region="af-south-1",OutputTableID="InvalidationList")
# Compare the local and S3 file to see how long it takes to be avaialable on S3.
CompareFiles(InputFile1="results/dataset-index.html",InputFile2="https://s3.us-west-2.amazonaws.com/data.openwaterfoundation.org/state/co/dwr/stream-reaches/index.html",IfDifferent=Warn,WaitUntil=FilesAreSame,WaitTimeout=600000,WaitInterval=60000)
# Compare the local and CloudFront file to see how long it takes to be avaialable on CloudFront.
CompareFiles(InputFile1="results/dataset-index.html",InputFile2="https://data.openwaterfoundation.org/state/co/dwr/stream-reaches/index.html",IfDifferent=Warn,WaitUntil=FilesAreSame,WaitTimeout=600000,WaitInterval=60000)
# Compare the index.html and folder name URLs to make sure that all variants were invalidated:
# - the AWS configuration should automatically add index.html to folders
CompareFiles(InputFile1="https://data.openwaterfoundation.org/state/co/dwr/stream-reaches/index.html",InputFile2="https://data.openwaterfoundation.org/state/co/dwr/stream-reaches/",IfDifferent=Warn,WaitUntil=FilesAreSame,WaitTimeout=600000,WaitInterval=60000)
CompareFiles(InputFile1="https://data.openwaterfoundation.org/state/co/dwr/stream-reaches/index.html",InputFile2="https://data.openwaterfoundation.org/state/co/dwr/stream-reaches",IfDifferent=Warn,WaitUntil=FilesAreSame,WaitTimeout=600000,WaitInterval=60000)
